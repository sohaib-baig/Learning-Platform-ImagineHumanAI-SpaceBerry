name: Pipeline A build push deploy

on:
  push:
    branches: 
      - develop
    
env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  GAR_REPO: ${{ secrets.GAR_REPO }}
  IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
  IMAGE_URI: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GAR_REPO }}/${{ secrets.IMAGE_NAME }}
  
jobs:
  build_push:
    runs-on: ubuntu-latest
    environment: sandbox
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Auth to Google Cloud using SA key
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure docker auth for Artifact Registry
        run: gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_URI }}:latest
            ${{ env.IMAGE_URI }}:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
            NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
            NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
            NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
            NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
            NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
            NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
            PLATFORM_DEVELOPER_PASSWORD=${{ secrets.PLATFORM_DEVELOPER_PASSWORD }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            STRIPE_PRICE_ID_TIER_A=${{ secrets.STRIPE_PRICE_ID_TIER_A }}
            STRIPE_PRICE_ID_TIER_B=${{ secrets.STRIPE_PRICE_ID_TIER_B }}
            STRIPE_PRICE_ID_TIER_C=${{ secrets.STRIPE_PRICE_ID_TIER_C }}

          
      - name: Cleanup Docker on GitHub runner
        if: always()
        run: |
          docker system prune -af --volumes || true
          
      
      - name: Deploy on VM via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.GCE_HOST }}
          username: ${{ secrets.GCE_USER }}
          key: ${{ secrets.GCE_SSH_KEY }}
          script: |
            set -e

            # If the VM has a service account attached with Artifact Registry Reader, this is enough
            gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

            docker compose pull
            docker compose up -d
            docker image prune -f || true